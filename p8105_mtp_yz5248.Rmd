---
title: "p8105_mtp_yz5248"
author: "yz5248"
date: "2025-10-18"
output: github_document
---

```{r}
library(readxl)
library(tidyverse)
library(knitr)
library(janitor)
library(lubridate)  
library(patchwork)
```

# Problem 1
## Importing and tiding data
```{r}
raw_df = 
  read_excel("p8105_mtp_data.xlsx", skip = 7) |>  
  janitor::clean_names() |>                     
  mutate(
    across(where(is.numeric), ~na_if(.x, -999)),  
    # sex was recoded from numeric indicators (0, 1) to labeled factors (“female”, “male”)
    sex = recode(sex, `0` = "female", `1` = "male"),
    sex = factor(sex, levels = c("male", "female")), 
    # age_group was transformed into ordered categorical groups (“18–30”, “31–40”, “41–50”, “51–60”, “60+”)
    age_group = case_when(
      age_group == 2 ~ "18–30",
      age_group == 3 ~ "31–40",
      age_group == 4 ~ "41–50",
      age_group == 5 ~ "51–60",
      age_group == c(6,7,8) ~ "60+",
      TRUE ~ NA_character_
    ),
    age_group = ordered(age_group,
                        levels = c("18–30", "31–40", "41–50", "51–60", "60+")),
    # create character and ordered factors for "eop_size"
    eop_size = case_when(
      eop_size == 0 ~ "small (0–5mm)",
      eop_size == 1 ~ "medium (5–10mm)",
      eop_size == 2:5 ~ "large (10mm+)",
      TRUE ~ NA_character_
    ),
    eop_size = ordered(eop_size, levels = c("small (0–5mm)", "medium (5–10mm)", "large (10mm+)")),
    # create character and ordered factors for "eop_visibility_classification"
    eop_visibility_classification = recode(eop_visibility_classification,
                                           `0` = "not_visible",
                                           `1` = "partially_visible",
                                           `2` = "visible"),
    eop_visibility_classification = ordered(
      eop_visibility_classification,
      levels = c("not_visible", "partially_visible", "visible")),
    # create character and ordered factors for "fhp_category"
    fhp_category = case_when(
      fhp_category == 0 ~ "none (0–10mm)",
      fhp_category == 1 ~ "mild (10–20mm)",
      fhp_category == 2 ~ "moderate (20–30mm)",
      fhp_category >= 3 ~ "severe (30mm+)",
      TRUE ~ NA_character_
    ),
    fhp_category = ordered(fhp_category,
                           levels = c("none (0–10mm)", "mild (10–20mm)", "moderate (20–30mm)", "severe (30mm+)")),
    eop_shape = str_to_lower(eop_shape)
  ) |> 
  select(sex, age, age_group, everything()) 

raw_df

n_participants = nrow(raw_df)
n_participants

n_by_group = raw_df |>
  count(age_group, sex) |>
  arrange(age_group, sex)
n_by_group
```

The key variables here is age, sex, eop size, eop visibility, and fhp category.  
- Numeric variables coded as -999 were replaced with NA.  
- Sex was recoded from numeric indicators to labeled factors, and age_group was transformed into ordered categorical groups.  
- Categorical versions of eop size, eop visibility, and fhp category were generated to reflect the definitions described in the original report. 

The final dataset included 1,221 participants, with approximately equal numbers of males (607) and females (614). The age distribution was relatively uniform across the predefined age groups.
```{r}
age_sex_table <- raw_df |>
  filter(!is.na(age_group)) |>
  tabyl(sex, age_group) |>
  adorn_totals(where = c("row", "col")) |>
  adorn_percentages("row") |>
  adorn_pct_formatting(digits = 1) |>
  kable(caption = "Table 1. Age group distribution by sex")

age_sex_table

```

## checking whether fhp_category correctly implement the definitions based on underlying fhp_size_mm
```{r}
# Create a new variable based on the continuous measure
fhp_check = raw_df |>
  mutate(
    fhp_cat_from_size = case_when(
      fhp_size_mm < 10 ~ "none (0–10mm)",
      fhp_size_mm < 20 ~ "mild (10–20mm)",
      fhp_size_mm < 30 ~ "moderate (20–30mm)",
      fhp_size_mm >= 30 ~ "severe (30mm+)",
      TRUE ~ NA_character_
    ),
    fhp_cat_from_size = ordered(
      fhp_cat_from_size,
      levels = c("none (0–10mm)", "mild (10–20mm)", "moderate (20–30mm)", "severe (30mm+)")
    )
  ) |>
  filter(fhp_category != fhp_cat_from_size) |>
  select(sex, age, fhp_size_mm, fhp_category, fhp_cat_from_size) |>
  head(10)
fhp_check

```
Comparison between fhp_category and fhp_size_mm values reveals several inconsistencies. For example, subjects with FHP sizes of 21–25 mm are sometimes labeled as mild rather than moderate, and those with values above 30 mm are occasionally categorized as mild or moderate instead of severe, which indicate that the categorical variable fhp_category does not strictly follow the definitions implied by the underlying continuous measurements.

# Visualization
```{r}
plot_df = raw_df |>
  mutate(
    eeop = eop_size == "large (10mm+)",
    fhp_mm = fhp_size_mm
  )

new_Figure3 = plot_df |>
  ggplot(aes(x = sex, y = fhp_size_mm, fill = sex)) +
  geom_boxplot(alpha = 0.6, outlier.color = "red") +
  facet_wrap(~ age_group, nrow = 1) +
  labs(
    title = "Distribution of FHP Size",
    x = "Sex",
    y = "FHP Size (mm)",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  )
new_Figure3


new_Figure4 = plot_df |>
  mutate(enlarged_eop = if_else(eop_size_mm >= 10, 1, 0)) |>
  group_by(sex, age_group) |>
  summarise(
    n = n(),
    eeop_rate = mean(enlarged_eop, na.rm = TRUE)
  ) |>
  ggplot(aes(x = age_group, y = eeop_rate, fill = sex)) +
  geom_col(position = position_dodge()) +
  geom_text(
    aes(label = scales::percent(eeop_rate, accuracy = 1)),
    position = position_dodge(width = 0.9),
    vjust = -0.5,
    size = 3
  ) +
  labs(
    title = "Prevalence of Enlarged EOP (≥10mm) by Age and Sex",
    x = "Age Group",
    y = "Proportion with Enlarged EOP (EEOP)",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 12)
new_Figure4 

# Combine into a two-panel figure
two_panel_fig = new_Figure3 + new_Figure4 + plot_layout(ncol = 2)
two_panel_fig
```
Left panel shows larger fhp in males and older participants—details hidden in the original summary statistics.  
Right panel, the plot shows that the prevalence of enlarged eop increases with age in both males and females, with males generally having a higher prevalence across all age groups.    
Overall, these figures highlight sex and age differences but do not support a causal link between smartphone use and eop growth.

```{r}
fhp_eop_plot = raw_df |>
  filter(!is.na(fhp_size_mm), !is.na(eop_size_mm), !is.na(sex), !is.na(age_group)) |>
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm, color = sex)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  facet_grid(sex ~ age_group) +
  labs(
    title = "Association between FHP and EOP across Age and Sex Groups",
    x = "FHP size (mm)", 
    y = "EOP size (mm)",
    color = "Sex"
  ) +
  theme_minimal()
fhp_eop_plot

```
The plots show a weak positive association between fhp and eop size in males across most age groups, while females display little or no clear relationship. Males generally have larger eop sizes than females, and age does not appear to substantially affect the association.

# Results and Discussion
```{r}
n_total = nrow(raw_df)
n_total

n_by_group = raw_df |>
  count(age_group, sex) |>
  arrange(age_group, sex)
n_by_group
```
In the original report, the authors stated that their sample consisted of 1,200 participants, approximately equally distributed across five age groups and both sexes.   
In our dataset, the total number of observations is 1,221, which aligns well with the reported total. The distribution by age and sex is roughly balanced, consistent with the design described by the authors.

```{r}
fhp_by_sex = raw_df |>
  group_by(sex) |>
  summarise(
    n = n(),
    mean_fhp = mean(fhp_size_mm, na.rm = TRUE),
    sd_fhp = sd(fhp_size_mm, na.rm = TRUE),
    median_fhp = median(fhp_size_mm, na.rm = TRUE)
  )
fhp_by_sex |>
  knitr::kable(caption = "FHP summary by sex")

```
The original paper reported the mean fhp as approximately 27.6 ± 13.3 mm for males and 24.0 ± 10.9 mm for females.  
The results are highly consistent with the published values. The small differences likely reflect random variation or rounding.

```{r}
raw_df = raw_df |>
  mutate(eeop = if_else(!is.na(eop_size_mm) & eop_size_mm >= 10, 1, 0))

eeop_overall <- raw_df |>
  summarise(
    n = n(),
    n_eeop = sum(eeop, na.rm = TRUE),
    prevalence = mean(eeop, na.rm = TRUE)
  )
eeop_overall

eeop_by_group = raw_df |>
  group_by(age_group, sex) |>
  summarise(
    n = n(),
    n_eeop = sum(eeop, na.rm = TRUE),
    prevalence = mean(eeop, na.rm = TRUE)
  ) |>
  arrange(age_group, sex) |>
  knitr::kable(caption = "EEOP prevalence (>=10 mm) by age_group and sex")
eeop_by_group
```
In the article, eeop was defined as eop size ≥ 10 mm, measured as the maximum projection of the bony growth.   
In our result: eeop prevalence = 32.2%, which is almost identical to the authors’ reported 33%. 
```{r}
f_hp_gt40_by_age = raw_df |>
  mutate(fhp_gt40 = if_else(!is.na(fhp_size_mm) & fhp_size_mm > 40, 1L, 0L)) |>
  group_by(age_group) |>
  summarise(
    n = n(),
    n_gt40 = sum(fhp_gt40, na.rm = TRUE),
    prop_gt40 = mean(fhp_gt40, na.rm = TRUE)
  ) |>
  arrange(age_group) |>
  knitr::kable(
    caption = "Proportion with FHP > 40 mm by age_group",
    digits = 3
  )
f_hp_gt40_by_age
```
In our analysis, the proportion of participants aged 60+ with fhp > 40 mm is 35.7%, almost exactly the same as the 34.5% reported by the authors.
Furthermore, the trend—showing that fhp > 40 mm becomes more frequent in older age groups, which are consistent with the original findings.



