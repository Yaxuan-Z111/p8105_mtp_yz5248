---
title: "p8105_mtp_yz5248"
author: "yz5248"
date: "2025-10-18"
output: github_document
---

```{r}
library(readxl)
library(tidyverse)
library(knitr)
library(janitor)
library(lubridate)  
library(patchwork)
```

# Importing and tiding data
```{r}
raw_df = 
  read_excel("p8105_mtp_data.xlsx", skip = 7) |>  
  janitor::clean_names() |>                     
  mutate(
    across(where(is.numeric), ~na_if(.x, -999)),  
    sex = recode(sex, `0` = "female", `1` = "male"),
    sex = factor(sex, levels = c("male", "female")),
    age_group = case_when(
      age_group == 2 ~ "18–30",
      age_group == 3 ~ "31–40",
      age_group == 4 ~ "41–50",
      age_group == 5 ~ "51–60",
      age_group == c(6,7,8) ~ "60+",
      TRUE ~ NA_character_
    ),
    age_group = ordered(age_group,
                        levels = c("18–30", "31–40", "41–50", "51–60", "60+")),
    eop_size = case_when(
      eop_size == 0 ~ "small (0–5mm)",
      eop_size == 1 ~ "medium (5–10mm)",
      eop_size == 2:5 ~ "large (10mm+)",
      TRUE ~ NA_character_
    ),
    eop_size = ordered(eop_size, levels = c("small (0–5mm)", "medium (5–10mm)", "large (10mm+)")),
    eop_visibility_classification = recode(eop_visibility_classification,
                                           `0` = "not_visible",
                                           `1` = "partially_visible",
                                           `2` = "visible"),
    eop_visibility_classification = ordered(
      eop_visibility_classification,
      levels = c("not_visible", "partially_visible", "visible")),
    fhp_category = case_when(
      fhp_category == 0 ~ "none (0–10mm)",
      fhp_category == 1 ~ "mild (10–20mm)",
      fhp_category == 2 ~ "moderate (20–30mm)",
      fhp_category >= 3 ~ "severe (30mm+)",
      TRUE ~ NA_character_
    ),
    fhp_category = ordered(fhp_category,
                           levels = c("none (0–10mm)", "mild (10–20mm)", "moderate (20–30mm)", "severe (30mm+)")),
    eop_shape = str_to_lower(eop_shape)
  ) |> 
  select(sex, age, age_group, everything()) 

raw_df
```

```{r}
n_participants <- nrow(raw_df)

age_sex_table <- raw_df |>
  filter(!is.na(age_group)) |>
  tabyl(sex, age_group) |>
  adorn_totals(where = c("row", "col")) |>
  adorn_percentages("row") |>
  adorn_pct_formatting(digits = 1) |>
  kable(caption = "Table 1. Age group distribution by sex")

n_participants
age_sex_table

```

```{r}
raw_df |>
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 5, fill = "skyblue", color = "white") +
  labs(title = "Age Distribution", x = "Age (years)", y = "Count")
```


# Visualization
```{r}
plot_df = raw_df |>
  mutate(
    eeop = eop_size == c("large (10mm+)"),
    fhp_mm = fhp_size_mm
  )

new_Figure3 = plot_df |>
  ggplot(aes(x = fhp_size_mm, fill = sex)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ age_group, nrow = 1) +
  labs(
    title = "Distribution of Forward Head Posture (FHP) size",
    x = "FHP size (mm)",
    y = "Density",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 12)
new_Figure3 


new_Figure4 = plot_df |>
  mutate(enlarged_eop = if_else(eop_size_mm >= 10, 1, 0)) |>
  group_by(sex, age_group) |>
  summarise(
    n = n(),
    eeop_rate = mean(enlarged_eop, na.rm = TRUE)
  ) |>
  ggplot(aes(x = age_group, y = eeop_rate, fill = sex)) +
  geom_col(position = position_dodge()) +
  geom_text(
    aes(label = scales::percent(eeop_rate, accuracy = 1)),
    position = position_dodge(width = 0.9),
    vjust = -0.5,
    size = 3
  ) +
  labs(
    title = "Prevalence of Enlarged EOP (≥10mm) by Age and Sex",
    x = "Age Group",
    y = "Proportion with Enlarged EOP (EEOP)",
    fill = "Sex"
  ) +
  theme_minimal(base_size = 12)
new_Figure4 

# Combine into a two-panel figure
two_panel_fig = new_Figure3 + new_Figure4 + plot_layout(ncol = 2)
two_panel_fig
```

```{r}
fhp_eop_plot = raw_df |>
  filter(!is.na(fhp_size_mm), !is.na(eop_size_mm), !is.na(sex), !is.na(age_group)) |>
  ggplot(aes(x = fhp_size_mm, y = eop_size_mm, color = sex)) +
  geom_point(alpha = 0.6, size = 2) +
  geom_smooth(method = "lm", se = FALSE, color = "black") +
  facet_grid(sex ~ age_group) +
  labs(
    title = "Association between FHP and EOP across Age and Sex Groups",
    x = "FHP size (mm)", 
    y = "EOP size (mm)",
    color = "Sex"
  ) +
  theme_minimal()
fhp_eop_plot

```

# Results and Discussion
```{r}
n_total = nrow(raw_df)
n_total

n_by_group = raw_df |>
  count(age_group, sex) |>
  arrange(age_group, sex)
n_by_group
```

```{r}
fhp_by_sex = raw_df |>
  group_by(sex) |>
  summarise(
    n = n(),
    mean_fhp = mean(fhp_size_mm, na.rm = TRUE),
    sd_fhp = sd(fhp_size_mm, na.rm = TRUE),
    median_fhp = median(fhp_size_mm, na.rm = TRUE)
  )
fhp_by_sex |>
  knitr::kable(caption = "FHP summary by sex")

```

```{r}
raw_df = raw_df |>
  mutate(eeop = if_else(!is.na(eop_size_mm) & eop_size_mm >= 10, 1, 0))

eeop_overall <- raw_df |>
  summarise(
    n = n(),
    n_eeop = sum(eeop, na.rm = TRUE),
    prevalence = mean(eeop, na.rm = TRUE)
  )
eeop_overall

eeop_by_group = raw_df |>
  group_by(age_group, sex) |>
  summarise(
    n = n(),
    n_eeop = sum(eeop, na.rm = TRUE),
    prevalence = mean(eeop, na.rm = TRUE)
  ) |>
  arrange(age_group, sex) |>
  knitr::kable(caption = "EEOP prevalence (>=10 mm) by age_group and sex")
eeop_by_group
```

```{r}
f_hp_gt40_by_age = raw_df |>
  mutate(fhp_gt40 = if_else(!is.na(fhp_size_mm) & fhp_size_mm > 40, 1L, 0L)) |>
  group_by(age_group) |>
  summarise(
    n = n(),
    n_gt40 = sum(fhp_gt40, na.rm = TRUE),
    prop_gt40 = mean(fhp_gt40, na.rm = TRUE)
  ) |>
  arrange(age_group) |>
  knitr::kable(
    caption = "Proportion with FHP > 40 mm by age_group",
    digits = 3
  )
f_hp_gt40_by_age
```




